name: CI

on:
  push:
    branches: [ main ]
  pull_request:
# Disabled for now, as we don't want to run CI twice
# merge_group:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  ci-build-and-unit-tests:
    name: CI for build and unit tests
    uses: ./.github/workflows/ci-build-and-unit-tests.yaml

  ci-integration-tests:
    name: CI for integration tests
    uses: ./.github/workflows/ci-integration-tests.yaml

  ci-success:
    name: Github Status Check
    runs-on: ubuntu-latest
    if: always() && !cancelled()
    needs:
      [
        ci-build-and-unit-tests,
        ci-integration-tests,
      ]
    steps:
      - name: Status
        run: |
          # This will check all jobs status in the `needs` list, and fail job if one is failed.
          # Since we split prover and core to different flows, this job will be only as Required Status Check in the Pull Request.
          if [[ ${{ contains(join(needs.*.result, ','), 'failure') }} == "true" ]]; then
            echo "Intentionally failing to block PR from merging"
            exit 1
          fi
